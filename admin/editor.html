<!doctype html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <title>Macé Cafe — Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,body{height:100%}
      body{ margin:0; background:#fafafa; color:#111; font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
      .loading{ padding:16px; max-width:720px; margin:24px auto; }
      .loading p{ margin:.4rem 0; color:#444 }
      .err{ color:#b00020; font-weight:700 }
      @media (max-width: 1024px){
        input, select, textarea { font-size:16px; } /* prevent iOS zoom */
        .nc-appHeader{ position:sticky; top:0; z-index:5; }
        #nc-root, .css-1, .nc-root { padding:0 !important; }
      }
    </style>
    <!-- Identity so CMS can auth via Git Gateway -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="boot" class="loading">
      <h1 style="margin:.2rem 0 .4rem; font-size:20px">Laster editor …</h1>
      <p>Editor lastes nå fra <b>ditt eget nettsted</b>. Hvis dette står lenge, ser du en feilmelding.</p>
    </div>

    <script>
      /* Deep-link to a collection or single entry */
      (function(){
        const p = new URLSearchParams(location.search);
        const col = p.get('collection');
        const entryByCol = { dagens:'dagens', aapningstider:'hours', meny:'meny', forside:'home' };
        if (col) {
          const entry = entryByCol[col];
          if (entry) location.hash = '#/collections/' + col + '/entries/' + entry;
          else location.hash = '#/collections/' + col;
        }
      })();

      function initIdentity(){
        if (!window.netlifyIdentity) return;
        try { window.netlifyIdentity.init({}); } catch(e){}
        window.netlifyIdentity.on('init', (user) => {
          if (!user) { window.netlifyIdentity.open('login'); }
        });
      }

      function afterLoad(){
        const boot = document.getElementById('boot');
        if (boot) boot.remove();
      }

      function mountError(msg){
        const boot = document.getElementById('boot');
        if(!boot) return;
        boot.innerHTML = '<h1 style="margin:.2rem 0 .4rem; font-size:20px" class="err">Kunne ikke laste editor</h1>'
          + '<p>' + (msg || 'Lokale CMS-filer mangler.') + '</p>'
          + '<p>Tips: Sjekk at Netlify bygget filer til <code>admin/vendor/</code>. '
          + 'Se Build logs → run <code>fetch-cms.sh</code>.</p>';
      }

      function loadScript(src, onok, onfail){
        var s = document.createElement('script');
        s.src = src; s.async = true; s.onload = onok; s.onerror = onfail;
        document.head.appendChild(s);
      }

      initIdentity();

      // 1) Try local self-hosted bundles (no external CDNs)
      loadScript('/admin/vendor/decap-cms.js', afterLoad, function(){
        // 2) Local netlify-cms fallback (also self-hosted)
        loadScript('/admin/vendor/netlify-cms.js', afterLoad, function(){
          // 3) As a last resort, try external CDNs (in case local files are missing on first deploy)
          loadScript('https://unpkg.com/decap-cms@^3/dist/decap-cms.js', afterLoad, function(){
            loadScript('https://cdn.jsdelivr.net/npm/netlify-cms-app@^2/dist/netlify-cms.js', afterLoad, function(){
              mountError('Verken lokale eller eksterne CMS-filer kunne lastes.');
            });
          });
        });
      });
    </script>
  </body>
</html>
