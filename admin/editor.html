<!doctype html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <title>Macé Cafe — Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,body{height:100%}
      body{ margin:0; background:#fafafa; color:#111; font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
      .loading{ padding:16px; max-width:720px; margin:24px auto; }
      .loading p{ margin:.4rem 0; color:#444 }
      .err{ color:#b00020; font-weight:700 }
      @media (max-width: 1024px){
        input, select, textarea { font-size:16px; } /* prevent iOS zoom */
        .nc-appHeader{ position:sticky; top:0; z-index:5; }
        #nc-root, .css-1, .nc-root { padding:0 !important; }
      }
    </style>
    <!-- Identity so CMS can auth via Git Gateway -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="boot" class="loading">
      <h1 style="margin:.2rem 0 .4rem; font-size:20px">Laster editor …</h1>
      <p>Hvis dette står her lenge, prøver vi flere kilder automatisk.</p>
    </div>

    <script>
      /* Deep-link to a collection or single entry */
      (function(){
        const p = new URLSearchParams(location.search);
        const col = p.get('collection');
        const entryByCol = { dagens:'dagens', aapningstider:'hours', meny:'meny', forside:'home' };
        if (col) {
          const entry = entryByCol[col];
          if (entry) location.hash = '#/collections/' + col + '/entries/' + entry;
          else location.hash = '#/collections/' + col;
        }
      })();

      function mountError(){
        const boot = document.getElementById('boot');
        if(!boot) return;
        boot.innerHTML = '<h1 style="margin:.2rem 0 .4rem; font-size:20px" class="err">Kunne ikke laste editor</h1>'
          + '<p>Vi klarte ikke å laste Netlify/Decap CMS fra noen kilder (unpkg, jsDelivr, cdnjs, esm.sh).</p>'
          + '<p>Prøv å oppdatere siden, eller test på et annet nettverk.</p>';
      }

      function initIdentity(){
        if (!window.netlifyIdentity) return;
        try { window.netlifyIdentity.init({}); } catch(e){}
        window.netlifyIdentity.on('init', (user) => {
          if (!user) { window.netlifyIdentity.open('login'); }
        });
      }

      function afterLoad(){
        const boot = document.getElementById('boot');
        if (boot) boot.remove();
      }

      function loadScript(src, onok, onfail){
        const s = document.createElement('script');
        s.src = src; s.async = true; s.onload = onok; s.onerror = onfail;
        document.head.appendChild(s);
      }

      /* Try multiple providers (Netlify CMS app and Decap CMS) */
      const sources = [
        'https://unpkg.com/netlify-cms-app@^2/dist/netlify-cms.js',
        'https://cdn.jsdelivr.net/npm/netlify-cms-app@^2/dist/netlify-cms.js',
        'https://cdnjs.cloudflare.com/ajax/libs/decap-cms/3.1.9/decap-cms.min.js',
        'https://esm.sh/decap-cms@^3?bundle'
      ];

      function tryNext(i){
        if (i >= sources.length){ mountError(); return; }
        loadScript(sources[i], () => {
          /* Give the bundle a tick to expose the global */
          setTimeout(() => {
            if (window.CMS || window.DecapCms){
              afterLoad(); /* CMS auto-reads /admin/config.yml */
            } else {
              tryNext(i+1);
            }
          }, 60);
        }, () => tryNext(i+1));
      }

      initIdentity();
      tryNext(0);
    </script>
  </body>
</html>
